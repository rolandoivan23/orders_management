

<style>
	.bordered{
		border: solid 1px #cba;
	}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

{% csrf_token %}
<div class="container">
	<div class="row">
		<div class="col-sm-12">
			<span>La orden es urgente: </span>
			<span> <input type="checkbox" name="urgent"> </span>
			<div id="detail-warehouse-container">
				<label >Almacen</label>
				<input type="text" name="warehouse" placeholder="Número de almacen">
			</div>
			<div id="detail-sucursal-container" style="display: none;">
				<label >Reference</label>
				<input type="text" name="reference">
				<label >Código Sucursal</label>
				<input type="text" name="sucursal_code">
			</div>
			<div id="detail-associatedcompany-container" style="display: none;">
				<label >Referencia</label>
				<input type="text" name="reference">
				<label>Código del socio</label>
				<input type="text" name="member_code">
			</div>
		</div>
	</div>
	<div class="row">

		<div class="col-sm-12 col-md-7 bordered">
			<h4>Articulos de la orden</h4>
			<hr>
			<table id="articles-order-table" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>Code</th>
						<th>Description</th>
						<th>Quantity</th>
						<th>Subtotal</th>
					</tr>
				</thead>
				<tbody>
					
				</tbody>
			</table>
			<div class="row">
				<div class="col-md-8" style="font-size: 10px;">
					<div style="font-size: 12px;">Order Type:</div > 
					<input type="radio" id="order-type-1" name="order_type" onClick="check_order_type(this);" value="1" checked>
					<label for="order-type-1">Centro de distribución</label><br>
					<input type="radio" id="order-type-2" name="order_type" onClick="check_order_type(this);" value="2">
					<label for="order-type-1">Sucursal</label><br>
					<input type="radio" id="order-type-3" name="order_type" onClick="check_order_type(this);" value="3">
					<label for="order-type-3">Empresa Asociada</label>
				</div>
				<div class="col-md-4">
					<b>Total: $ </b>
				</div>
				
			</div>
		</div>
		<div class="col-sm-12 col-md-3 bordered">
			<div class="field-container">
				<label>Articulo</label>
				<input type="text" name="article_finder" class="input" />
				<h4>Listado de articulos</h4>
				<table  class="table-bordered table-collapsed">
					<thead>
						<tr>
							<th>Code</th>
							<th>Description</th>
							<th>Add to Order</th>
						</tr>
					</thead>
					<tbody>
						{% for article in articles %}
							<tr>
								<td> {{ article.code }} </td>
								<td> {{ article.description }} </td>
								<td> <div class="btn btn-outline-dark btn-sm" onclick="add_article_to_order({{article.id}}, '{{ article.code }}', '{{ article.description }}');">+</div></td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12 text-center">
			<button class="btn btn-success" onclick="save_order();">MAKE ORDER</button>
		</div>
	</div>


	
	<script>

		let order_articles = [];

		function add_article_to_order(article_id, code, desc) {
			let quantity = prompt('Introduzca la cantidad de articulos a agregar:');
			if(parseInt(quantity) > 0){
				$('#articles-order-table tbody').append(`<tr>\
					<td>${code}</td> \
					<td>${desc}</td> \
					<td>${quantity}</td> \
					<td></td> \
				</tr>`);
				order_articles.push({article_id: article_id, quantity: quantity});
			}else if(quantity != null){
				alert('No es una cantidad valida');
			}
		}

		function check_order_type(selection){
			switch(parseInt(selection.value)){
				case 1: $('#detail-warehouse-container').css('display', 'block');
						$('#detail-sucursal-container').css('display', 'none');
						$('#detail-associatedcompany-container').css('display', 'none');
					break;
				case 2: $('#detail-sucursal-container').css('display', 'block'); 
						$('#detail-warehouse-container').css('display', 'none');
						$('#detail-associatedcompany-container').css('display', 'none');
					break;
				case 3: $('#detail-associatedcompany-container').css('display', 'block'); 
						$('#detail-sucursal-container').css('display', 'none');
						$('#detail-warehouse-container').css('display', 'none');
					break;
			}
		}

		function save_order(){
			//let order_type_id = parseInt($('input[name=order_type]:checked')[0].value());
			//alert(order_articles);
			const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
			
			
			data = { 
		           articles: JSON.stringify(order_articles),
		           order_type_id: parseInt($('input[name=order_type]:checked')[0].value),
		           urgent: $('input[name=urgent]').is(':checked'),
		           csrfmiddlewaretoken: csrftoken
		       };

		      //ALMACEN
		     if(parseInt($('input[name=order_type]:checked')[0].value) == 1){
		           data.warehouse_id = parseInt($('input[name=warehouse]')[0].value);
		     }
		     if(parseInt($('input[name=order_type]:checked')[0].value) == 2 ){
		           data.reference = $('input[name=reference]')[0].value;
		           data.sucursal_code = $('input[name=sucursal_code]')[0].value;
		     }
		     if(parseInt($('input[name=order_type]:checked')[0].value) == 3  ){
		           data.reference =  $('input[name=reference]')[0].value;
		           data.partner_code = $('input[name=sucursal_code]')[0].value;
		     }

			 $.post('/save_order', data);
		}
	</script>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>