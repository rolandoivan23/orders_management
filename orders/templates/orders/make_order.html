{% extends 'base.html' %}




{% csrf_token %}

{% block contenido %}
<style>
	.bordered{
		border: solid 1px #b5b1ae;
		padding: 13px;
	}
</style>
<div class="container">
	<h1>Orders Maker</h1>




	<div class="row">
		<div class="col-sm-12 bordered">
			<h6>Datos Generales</h6>

			<div class="row">
				<div class="col-md-9" style="font-size: 10px;">
					<div style="margin-bottom:  7px;" class="btn-group" role="group" aria-label="Basic radio toggle button group">	
						<span style="font-size: 11px; margin-right: 5px;">Order Type:</span> 
						<input class="btn-check" type="radio" id="order-type-1" name="order_type" onClick="check_order_type(this);" value="1" checked>
						<label style="font-size: 0.7rem; line-height: 0.5rem;" class="btn btn-outline-secondary" for="order-type-1">Centro de distribución</label><br>
						<input class="btn-check" type="radio" id="order-type-2" name="order_type" onClick="check_order_type(this);" value="2">
						<label style="font-size: 0.7rem; line-height: 0.5rem;" class="btn btn-outline-secondary" for="order-type-2">Sucursal</label><br>
						<input class="btn-check" type="radio" id="order-type-3" name="order_type" onClick="check_order_type(this);" value="3">
						<label style="font-size: 0.7rem; line-height: 0.5rem;" class="btn btn-outline-secondary" for="order-type-3">Empresa Asociada</label>
					</div>

					<br>
					<div id="detail-warehouse-container">
						<div class="row">
							<div class="col-sm-12 col-md-5">
								<label >Almacen</label>
								<div class="dx-field">
									<div id="cmb-warehouses"></div>
									
								</div>
								
							</div>
						</div>
					</div>
					<div id="detail-sucursal-container" style="display: none;">
						<div class="row">
							<div class="col-sm-12 col-md-6">
								<label >Reference</label>
								<input class="form-control form-control-sm" type="text" name="reference" placeholder="Ej, OU51214-CH03">
							</div>
							<div class="col-sm-12 col-md-6">
								<label >Código Sucursal</label>
								<input class="form-control form-control-sm" type="text" name="sucursal_code" placeholder="Introduzca el código de la sucursal">
							</div>
						</div>
					</div>
					<div id="detail-associatedcompany-container" style="display: none;">
						<div class="row">
							<div class="col-sm-12 col-md-6">
								<label >Referencia</label>
								<input  placeholder="Ej, OU51214-CH03" class="form-control form-control-sm" type="text" name="reference">
							</div>
							<div class="col-sm-12 col-md-6">
								<label>Código del socio</label>
								<input class="form-control form-control-sm" type="text" name="member_code" placeholder="Introduzca el código del socio">
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-3">
					<label class="form-check-label" for="chkUrgent"> La orden es urgente:</label>
					 <input id="chkUrgent" class="form-check-input" type="checkbox" name="urgent"> 
				</div>
			</div>

			
			
		</div>
	</div>
	<div class="row">

		<div class="col-sm-12 col-md-7 bordered">
			<h5>Artículos de la orden</h5>
			<hr>
			<table id="articles-order-table" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>Code</th>
						<th>Description</th>
						<th>Quantity</th>
						<th>Price</th>
						<th>Subtotal</th>
					</tr>
				</thead>
				<tbody>
					
				</tbody>
			</table>
			<div class="row">
				<div class="col-sm-12 col-md-3 offset-md-7"><b>Total: $ </b></div>
			</div>
			
		</div>
		<div class="col-sm-12 col-md-5 bordered">
			<div class="field-container" style="text-align: 
			center;">
				<!--<label>Articulo</label>
				<input type="text" name="article_finder" class="input" />-->
				<h5>Listado de artículos</h5>
				<div id="grid-articulos"></div>
				
			</div>
			<small style="font-size: 9px; position: relative; bottom: -18px;">Doble click para agregar o con el botón +</small>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-12 text-center mt-3 mb-2">
			<button class="btn btn-success" onclick="save_order();">MAKE ORDER</button>
		</div>
	</div>


	
	<script>

		let order_articles = [];

		function add_article_to_order(article_id, code, desc, price) {
			let quantity = prompt('Introduzca la cantidad de articulos a agregar:');
			if(parseInt(quantity) > 0){
				$('#articles-order-table tbody').append(`<tr>\
					<td>${code}</td> \
					<td>${desc}</td> \
					<td>${quantity}</td> \
					<td>${price}</td> \
					<td>${quantity*price}</td> \
				</tr>`);
				order_articles.push({article_id: article_id, quantity: quantity});
				articles.length = 0;
				instanceGridArticles.refresh();

			}else if(quantity != null){
				alert('No es una cantidad valida');
			}
		}

		function check_order_type(selection){
			switch(parseInt(selection.value)){
				case 1: $('#detail-warehouse-container').css('display', 'block');
						$('#detail-sucursal-container').css('display', 'none');
						$('#detail-associatedcompany-container').css('display', 'none');
					break;
				case 2: $('#detail-sucursal-container').css('display', 'block'); 
						$('#detail-warehouse-container').css('display', 'none');
						$('#detail-associatedcompany-container').css('display', 'none');
					break;
				case 3: $('#detail-associatedcompany-container').css('display', 'block'); 
						$('#detail-sucursal-container').css('display', 'none');
						$('#detail-warehouse-container').css('display', 'none');
					break;
			}
		}

		function save_order(){
			//let order_type_id = parseInt($('input[name=order_type]:checked')[0].value());
			//alert(order_articles);
			const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
			
			
			data = { 
		           articles: JSON.stringify(order_articles),
		           order_type_id: parseInt($('input[name=order_type]:checked')[0].value),
		           urgent: $('input[name=urgent]').is(':checked'),
		           csrfmiddlewaretoken: csrftoken
		       };

		      //ALMACEN
		     if(parseInt($('input[name=order_type]:checked')[0].value) == 1){
		           data.warehouse_id = parseInt($('input[name=warehouse]')[0].value);
		     }
		     if(parseInt($('input[name=order_type]:checked')[0].value) == 2 ){
		           data.reference = $('input[name=reference]')[0].value;
		           data.sucursal_code = $('input[name=sucursal_code]')[0].value;
		     }
		     if(parseInt($('input[name=order_type]:checked')[0].value) == 3  ){
		           data.reference =  $('input[name=reference]')[0].value;
		           data.partner_code = $('input[name=sucursal_code]')[0].value;
		     }

			 $.post('/save_order', data).then(resp => {
			 	alert('Orden guardada');
			 }, error => {
			 	console.error('Error al guardar la orden' + error);
			 	alert('Error al guardar');
			 });
		}
	</script>
</div>

{% endblock contenido %}


